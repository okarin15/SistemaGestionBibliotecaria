<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mis Préstamos - Biblioteca Luz del Saber</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">

<!-- NAVBAR -->
<nav class="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-xl md:text-2xl font-bold">
            <i class="fas fa-book-reader mr-2"></i>SGB Luz del Saber
        </h1>
        <div class="flex items-center gap-3">
            <div class="text-right text-xs hidden sm:block">
                <p>{{ usuario.get_full_name|default:usuario.username }}</p>
                <p class="opacity-75">{{ rol }}</p>
            </div>
            <a href="{% url 'logout' %}"
               class="text-xs bg-red-600 hover:bg-red-700 px-3 py-1 rounded-full">
                Cerrar sesión
            </a>
        </div>
    </div>
</nav>


<div class="container mx-auto p-4 md:p-6 space-y-6">

    <!-- MENSAJES DJANGO -->
    {% if messages %}
        <div class="space-y-1">
            {% for message in messages %}
                <p class="text-sm p-2 rounded
                   {% if message.tags == 'success' %}
                        bg-green-100 text-green-700
                   {% elif message.tags == 'error' %}
                        bg-red-100 text-red-700
                   {% else %}
                        bg-blue-100 text-blue-700
                   {% endif %}">
                    {{ message }}
                </p>
            {% endfor %}
        </div>
    {% endif %}

    <!-- SOLICITAR NUEVO PRÉSTAMO -->
    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-600">
        <h2 class="text-lg font-bold mb-3 text-blue-900 flex items-center">
            <span class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-2 text-sm">
                1
            </span>
            Solicitar nuevo préstamo
        </h2>

        <form method="post" action="{% url 'crear_solicitud' %}" class="space-y-4">
            {% csrf_token %}
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">
                    Libro que deseas solicitar
                </label>
                <select id="requestBookSelect"
                        name="titulo_libro"
                        class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
                </select>
                <p class="text-xs text-gray-400 mt-1">
                    Solo se muestran libros disponibles en el inventario del sistema.
                </p>
            </div>

            <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow flex items-center justify-center gap-2">
                <i class="fas fa-paper-plane"></i> Enviar solicitud
            </button>
        </form>
    </div>


    <!-- SOLICITUDES DEL USUARIO -->
    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-purple-600">
        <h2 class="text-lg font-bold mb-3 text-purple-900 flex items-center">
            <span class="bg-purple-100 text-purple-600 w-8 h-8 rounded-full flex items-center justify-center mr-2 text-sm">
                2
            </span>
            Mis solicitudes de préstamo
        </h2>

        {% if solicitudes %}
            <ul class="space-y-2 text-sm text-gray-700">
                {% for s in solicitudes %}
                    <li class="border rounded p-2 flex justify-between items-center bg-gray-50">
                        <span>
                            <strong>{{ s.titulo_libro }}</strong>
                            <span class="text-xs text-gray-500">
                                - {{ s.fecha_solicitud|date:"d/m/Y H:i" }}
                            </span>
                        </span>
                        <span class="text-[10px] uppercase px-2 py-1 rounded-full
                            {% if s.estado == 'pendiente' %}
                                bg-yellow-100 text-yellow-700
                            {% elif s.estado == 'aprobado' %}
                                bg-green-100 text-green-700
                            {% else %}
                                bg-red-100 text-red-700
                            {% endif %}">
                            {% if s.estado == 'pendiente' %}
                                En revisión
                            {% elif s.estado == 'aprobado' %}
                                Préstamo activo
                            {% else %}
                                Rechazado
                            {% endif %}
                        </span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-xs text-gray-500">
                Aún no has realizado solicitudes de préstamo.
            </p>
        {% endif %}
    </div>

</div>


<script>
    // Misma clave que usa el panel de admin
    const BOOKS_KEY = "sgb_books_demo";

    // Libros base por si aún no hay nada en localStorage
    const defaultBooks = [
        { id: 1, title: "Cien Años de Soledad", author: "Gabo", status: "Disponible" },
        { id: 2, title: "Clean Code", author: "R. Martin", status: "Disponible" },
        { id: 3, title: "El Principito", author: "Saint-Exupéry", status: "Prestado" },
        { id: 4, title: "1984", author: "Orwell", status: "Disponible" },
        { id: 5, title: "Don Quijote", author: "Cervantes", status: "Disponible" }
    ];

    function loadBooks() {
        const saved = localStorage.getItem(BOOKS_KEY);
        if (saved) {
            try {
                return JSON.parse(saved);
            } catch (e) {
                return [...defaultBooks];
            }
        }
        return [...defaultBooks];
    }

    document.addEventListener('DOMContentLoaded', () => {
        const select = document.getElementById('requestBookSelect');
        if (!select) return;

        const books = loadBooks();
        select.innerHTML = "";

        const disponibles = books.filter(b => b.status === "Disponible");

        if (disponibles.length === 0) {
            const opt = document.createElement('option');
            opt.value = "";
            opt.textContent = "No hay libros disponibles";
            select.appendChild(opt);
            select.disabled = true;
        } else {
            // opción por defecto "Seleccione un libro"
            const optDefault = document.createElement('option');
            optDefault.value = "";
            optDefault.textContent = "Seleccione un libro";
            select.appendChild(optDefault);

            disponibles.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.title;   // se envía el título al backend
                opt.textContent = `${b.title} (${b.author})`;
                select.appendChild(opt);
            });

            select.disabled = false;
        }
    });
</script>

</body>
</html>
